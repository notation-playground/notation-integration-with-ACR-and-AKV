name: release-acr

on:
  push:
    tags:
      - v*

env:
  ACR_REGISTRY_TO_RELEASE: testnotation.azurecr.io
  ACR_REPO_TO_RELEASE: integration
  ACR_REGISTRY_USERNAME: testnotation
  ACR_REGISTRY_PASSWORD: ${{ secrets.ACR_REGISTRY_PASSWORD }}
  AKV_PLUGIN_REF: testnotation.azurecr.io/akv-plugin-linux@sha256:ee0b6ccbb6f4232e908c7a6876c10e56f5a02dff4537c30a38690fef1430a61b
  AKV_SUBSCRIPTION_ID: dfb63c8c-7c89-4ef8-af13-75c1d873c895
  AKV_NAME: testnotationAKV

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: prepare
        id: prepare
        run: |
          VERSION=${GITHUB_REF#refs/*/}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ "${VERSION}" == "${BRANCH_NAME}" ]]; then
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo ::set-output name=version::${VERSION}
          echo ::set-output name=ref::${{ env.ACR_REGISTRY_TO_RELEASE }}/${{ env.ACR_REPO_TO_RELEASE }}:${VERSION}
      - name: docker login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_REGISTRY_TO_RELEASE }}
          username: ${{ env.ACR_REGISTRY_USERNAME }}
          password: ${{ env.ACR_REGISTRY_PASSWORD }}
      - name: docker build
        run: |          
          docker build -t ${{ steps.prepare.outputs.ref }} .
          docker push ${{ steps.prepare.outputs.ref }}
      - name: akv login
        env:
          AZURE_TENANT_ID: 72f988bf-86f1-41af-91ab-2d7cd011db47
          AZURE_SERVICE_PRINCIPLE_CLIENT_ID: 40421dc0-256b-4501-a65f-7ae18ce999d5
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          run:
            # set permissions that AKV plugin needs
            az account set -s ${{ env.AKV_SUBSCRIPTION_ID }}
            az keyvault set-policy -n ${{ env.AKV_NAME }} --secret-permissions get list --key-permissions sign --certificate-permissions get --spn ${{ env.AZURE_SERVICE_PRINCIPLE_CLIENT_ID }}
      - name: setup notation
        uses: shizhMSFT/setup-notation@main
        with:
          version: v1.0.0-rc.7
          # Override the download url
          # TODO: add checksum
          url: https://github.com/Two-Hearts/notation/releases/download/v1.0.0-rc.7-pluginInstall/notation_1.0.0-rc.7-pluginInstall_linux_amd64.tar.gz
      - name: install notation plugin
        run: |
          notation plugin install --name azure-kv ${{ env.AKV_PLUGIN_REF }}
          notation plugin ls
      - name: sign released image
        run: |
          notation key add --plugin azure-kv --id "https://testnotationakv.vault.azure.net/keys/testNotationPEM/ea55efedc6eb4928b5294e7b172061e0" --default testKey
          notation sign --signature-format cose ${{ steps.prepare.outputs.ref }}
      - name: inspect signatures
        run:
          notation inspect ${{ steps.prepare.outputs.ref }}